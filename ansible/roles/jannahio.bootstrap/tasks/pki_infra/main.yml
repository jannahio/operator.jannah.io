---
- name: "Certificate Manager Setup"
  block:
    - name: Create ClusterIssuer
      kubernetes.core.k8s:
        state: '{{ Jannah.credentials[1].state }}'
        kubeconfig: '{{ Jannah.credentials[1].kubeconfig }}'
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: '{{ Jannah.credentials[1].ClusterIssuer.name }}'
          spec:
            selfSigned: {}
            annotations:
              pki-infra: cluster-issuer
            labels:
              qa-pki-infra: cluster-issuer
        wait: yes
      tags:
        - "d1d2-bootstrap-infra-pki"
        - "d1d2-operator"
    - name: Create Certificate
      kubernetes.core.k8s:
        state: '{{ Jannah.credentials[1].state }}'
        kubeconfig: '{{ Jannah.credentials[1].kubeconfig }}'
        definition:
          apiVersion: cert-manager.io/v1
          kind: Certificate
          metadata:
            name: '{{ Jannah.credentials[1].Certificate.name }}'
            namespace: '{{ Jannah.credentials[1].namespace }}'
          spec:
            isCA: true
            commonName: '{{ Jannah.credentials[1].Certificate.commonName }}'
            secretName: '{{ Jannah.credentials[1].Certificate.secretName }}'
            privateKey:
              algorithm: ECDSA
              size: 256
            issuerRef:
              name: '{{ Jannah.credentials[1].ClusterIssuer.name }}'
              kind: ClusterIssuer
              group: cert-manager.io
        wait: yes
      tags:
        - "d1d2-bootstrap-infra-pki"
        - "d1d2-operator"
    - name: Create Issuer
      kubernetes.core.k8s:
        state: '{{ Jannah.credentials[1].state }}'
        kubeconfig: '{{ Jannah.credentials[1].kubeconfig }}'
        definition:
          apiVersion: cert-manager.io/v1
          kind: Issuer
          metadata:
            name: '{{ Jannah.credentials[1].Issuer.name }}'
            namespace: '{{ Jannah.credentials[1].namespace }}'
          spec:
            ca:
              secretName: '{{ Jannah.credentials[1].Certificate.secretName }}'
            annotations:
              pki-infra: issuer
            labels:
              qa-pki-infra: issuer
        wait: yes
      tags:
        - "d1d2-bootstrap-infra-pki"
        - "d1d2-operator"
    