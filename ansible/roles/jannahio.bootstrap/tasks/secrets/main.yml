---
# Implements:
# https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-image-pull-secret-to-service-account
#- name: 'Create Registry Secret/ConfigMap'
#  kubernetes.core.k8s:
#    definition:
#      apiVersion: '{{ Jannah.stages.bootstrap.secrets.image_registry.apiVersion }}'
#      kind: Secret
#      metadata:
#        name: '{{ Jannah.stages.bootstrap.secrets.image_registry.name }}'
#        namespace: '{{ Jannah.global.namespace }}'
#      type: Opaque
#      stringData:
#        config.yaml: |
#          docker-server: '{{ Jannah.credentials.dockerhub.url }}'
#          docker-username: '{{ Jannah.credentials.dockerhub.USERNAME }}'
#          docker-password: '{{ Jannah.credentials.dockerhub.PASSWORD }}'
#          docker-email: '{{ Jannah.credentials.dockerhub.EMAIL }}'
#  tags:
#    - "bootstrap_docker_secrets"


- name: "Create Registry Secret"
  command: kubectl create secret docker-registry {{ Jannah.stages.bootstrap.secrets.image_registry.name }} --docker-server={{ Jannah.credentials.dockerhub.url }} \
    --docker-username={{ Jannah.credentials.dockerhub.USERNAME }} --docker-password={{ Jannah.credentials.dockerhub.PASSWORD }} \
    --docker-email={{ Jannah.credentials.dockerhub.EMAIL }}
  tags:
    - "bootstrap_docker_secrets"
    - "secrets_infra"

- name: "Create Registry Root Cert Secret"
  shell: |
    kubectl create secret generic {{ Jannah.stages.bootstrap.secrets.root_cert.name }} \
    --from-file={{ Jannah.stages.bootstrap.secrets.root_cert.key }}={{ Jannah.stages.bootstrap.secrets.root_cert.path }} \
    --namespace=default
  tags:
    - "bootstrap_docker_root_cert_secret"
    - "secrets_infra"

#kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "myregistrykey"}]}'
- name: "modify the default service account for the namespace to use this secret as an imagePullSecret"
  shell: |
    kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "{{ Jannah.stages.bootstrap.secrets.image_registry.name }}"}]}'
  tags:
    - "bootstrap_patch_serviceaccount_secrets"
    - "secrets_infra"


- name: "modify the default service account for the namespace to use this secret as an imagePullSecret"
  shell: |
    kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "{{ Jannah.stages.bootstrap.secrets.image_registry.name }}"}]}'
  tags:
    - "bootstrap_patch_serviceaccount_secrets"
    - "secrets_infra"

- name: "Get the default service account yaml for editing"
  shell: |
    kubectl get serviceaccounts default -o yaml > ./roles/jannahio.bootstrap/tasks/secrets/files/templates/service_account.yaml
  tags:
    - "bootstrap_get_serviceaccount_file"
    - "secrets_infra"

- name: "comment out line with resourceVersion"
  ansible.builtin.replace:
    path: ./roles/jannahio.bootstrap/tasks/secrets/files/templates/service_account.yaml
    regexp: 'resourceVersion:'
    replace: '#resourceVersion:'
  tags:
    - "bootstrap_comment_out_resourceVersion"
    - "secrets_infra"


- name: "Replace the serviceaccount with the new updated file"
  shell: |
    kubectl replace serviceaccount default -f ./roles/jannahio.bootstrap/tasks/secrets/files/templates/service_account.yaml
  tags:
    - "bootstrap_replace_serviceaccount"
    - "secrets_infra"